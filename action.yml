name: Terraform plan
description: Plan the Terraform script and (optionally) upload the resulting artifact
inputs:
  output-path:
    description: Path where to store the resulting output plan
    required: false
    default: output
  upload-artifact:
    description: Set to true to upload the resulting artifact with the TF plan
    required: false
    default: false
  validate-terraform:
    description: Set to true to validate the formatting of the TF files
    required: false
    default: true
  working-directory:
    description: Directory where to run the plan command
    required: false
    default: "."

runs:
  using: "composite"
  steps:

    - if: inputs.validate-terraform == 'true'
      name: Validate
      shell: bash
      run: terraform validate

    - name: Plan
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        export TF_VAR_created_by_ci="$CI"
        export TF_VAR_github_repo_name="$GITHUB_REPOSITORY"
        terraform plan \
          -out ${{ inputs.output-path }}

    - if: ${{ inputs.upload-artifact == 'true' }}
      uses: actions/upload-artifact@v2
      with:
        name: plan_output
        if-no-files-found: error
        path: ${{ inputs.working-directory }}/${{ inputs.output-path }}
